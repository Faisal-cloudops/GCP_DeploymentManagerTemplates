imports:
- path: vpcNetwork-template.jinja
- path: firewallRule-template.jinja
- path: serviceAccount-template.jinja
- path: iamPolicyPatch-template.jinja
- path: computeEngine-template.jinja
- path: cloudStorage-template.jinja
- path: route-template.jinja

resources:
- name: vpcNetwrok
  type: vpcNetwork-template.jinja
  properties:
    region: asia-northeast1
    publicSubnetRange: 172.20.0.0/24
    privateSubnetRange: 172.20.1.0/24

- name: inbound-allow-ssh
  type: firewallRule-template.jinja
  properties:
    direction: INGRESS
    priority: 1000
    targetTags:
    - natgw
    sourceRanges:
    - 0.0.0.0/0
    allowedRules:
    - IPProtocol: tcp
      ports:
      - '22'

- name: inbound-allow-rdp
  type: firewallRule-template.jinja
  properties:
    direction: INGRESS
    priority: 1000
    sourceRanges:
    - 0.0.0.0/0
    allowedRules:
    - IPProtocol: tcp
      ports:
      - '3389'

- name: inbound-allow-internal-all
  type: firewallRule-template.jinja
  properties:
    direction: INGRESS
    priority: 1000
    sourceRanges:
    - 172.20.0.0/21
    allowedRules:
    - IPProtocol: tcp
      ports:
      - '0-65535'
    - IPProtocol: udp
      ports:
      - '0-65535'

- name: service-account-analysis
  type: serviceAccount-template.jinja

- name: service-account-jumphost
  type: serviceAccount-template.jinja

- name: service-account-natgw
  type: serviceAccount-template.jinja

- name: add-iamPolicy-to-serviceaccount
  type: iamPolicyPatch-template.jinja
  metadata:
    dependsOn:
    - service-account-analysis
    - service-account-jumphost
    - service-account-natgw
  properties:
    gcpIamPolicyPatch:
      add:
      - role: roles/editor
        members:
        - serviceAccount:$(ref.service-account-analysis.email)
        - serviceAccount:$(ref.service-account-jumphost.email)
        - serviceAccount:$(ref.service-account-natgw.email)

- name: remove-iamPolicy-from-user
  type: iamPolicyPatch-template.jinja
  metadata:
    dependsOn:
    - add-iamPolicy-to-serviceaccount
  properties:
    gcpIamPolicyPatch:
      remove:
      - role: roles/editor
        members:
        - user:example@gmail.com

- name: analysis
  type: computeEngine-template.jinja
  properties:
    zone: asia-northeast1-c
    machineType: g1-small
    imageProject: windows-cloud
    imageFamily: windows-2012-r2
    diskSizeGb: 50
    diskType: pd-standard
    public_or_private: private
    internalIp: 172.20.1.11
    canIpForward: false
    serviceAccount: service-account-analysis
    windowsUsers:
    - name: user1
      password: XXXXX

- name: jumphost2
  type: computeEngine-template.jinja
  properties:
    zone: asia-northeast1-b
    machineType: g1-small
    imageProject: windows-cloud
    imageFamily: windows-2012-r2
    diskSizeGb: 50
    diskType: pd-standard
    public_or_private: public
    internalIp: 172.20.0.13
    canIpForward: false
    serviceAccount: service-account-jumphost
    windowsUsers:
    - name: user1
      password: XXXXX

- name: natgw
  type: computeEngine-template.jinja
  properties:
    zone: asia-northeast1-b
    machineType: f1-micro
    imageProject: centos-cloud
    imageFamily: centos-7
    diskSizeGb: 10
    diskType: pd-standard
    public_or_private: public
    internalIp: 172.20.0.12
    canIpForward: true
    serviceAccount: service-account-natgw
    users:
    - name: user1
      ssh_pub_key: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

- name: route-natgw
  type: route-template.jinja
  properties:
    tags:
    - private-subnet
    destRange: 0.0.0.0/0
    priority: 999
    nextHopInstance: natgw

- name: mybucket-for-file-storage-logs
  type: cloudStorage-template.jinja
  properties:
    storageClass: NEARLINE
    location: asia-northeast1
    versioning: true
    lifecycle:
      rule:
      - action:
          type: Delete
        condition:
          age: 366

- name: mybucket-for-file-storage
  type: cloudStorage-template.jinja
  properties:
    storageClass: REGIONAL
    location: asia-northeast1
    versioning: true
    logging:
      logBucket: mybucket-for-file-storage-logs